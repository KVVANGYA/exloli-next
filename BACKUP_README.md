# 定时备份功能说明

## 功能概述

本系统提供了完整的定时备份功能，可以将应用程序目录定时备份并发送到指定的Telegram群组或私有频道。

## 配置说明

在 `config.toml` 中添加以下配置：

```toml
[backup]
enabled = true                    # 是否启用备份功能
interval_hours = 24              # 备份间隔（小时）
target_chat_id = -1001234567890  # 目标群组或频道ID
enable_retention = true          # 是否启用文件保留策略
retention_days = 7               # 本地备份文件保留天数
compress = true                  # 是否压缩备份文件
file_prefix = "exloli_backup"    # 备份文件名前缀
```

### 配置参数详解

- **enabled**: 控制备份功能的开关
- **interval_hours**: 自动备份的时间间隔，单位为小时
- **target_chat_id**: 备份文件发送的目标聊天ID（群组或频道）
- **enable_retention**: 是否启用本地文件清理功能
- **retention_days**: 本地备份文件保留天数，超过此天数的文件将被自动删除
- **compress**: 
  - `true`: 创建 `.tar.gz` 压缩文件
  - `false`: 创建 `.tar` 未压缩文件
- **file_prefix**: 备份文件名的前缀

## 备份文件命名规则

备份文件按以下格式命名：
- 压缩文件: `{file_prefix}_YYYYMMDD_HHMMSS.tar.gz`
- 未压缩文件: `{file_prefix}_YYYYMMDD_HHMMSS.tar`

例如: `exloli_backup_20250829_103045.tar.gz`

## 功能特性

### 1. 自动定时备份
- 系统启动后自动开始定时备份
- 按配置的间隔时间执行备份任务
- 备份完成后自动发送到指定聊天

### 2. 手动备份
管理员可以使用 `/backup` 命令手动触发备份：
```
/backup
```

### 3. 文件保留策略
- 可配置本地备份文件保留天数
- 自动清理过期的备份文件
- 避免磁盘空间占用过多

### 4. 错误处理
- 完善的错误日志记录
- 备份失败时的重试机制
- 文件变更期间的处理策略
- SQLite数据库活跃状态的特殊处理
- 自动忽略非致命性警告

### 5. 压缩选项
- 支持压缩和非压缩两种模式
- 压缩模式可显著减少文件大小
- 非压缩模式备份速度更快

## 备份内容

系统会备份 `/app` 目录下的所有文件和子目录，包括：
- 应用程序二进制文件
- 配置文件
- 数据库文件
- 日志文件
- 其他应用数据

## 使用方法

### 1. 配置备份参数
编辑 `config.toml` 文件，设置备份相关参数。

### 2. 获取目标聊天ID
- 对于群组：邀请 @userinfobot 到群组，发送任意消息获取群组ID
- 对于频道：将机器人添加为管理员，使用频道的用户名或ID

### 3. 启动应用
启动应用后，备份服务会自动开始运行。

### 4. 监控备份状态
查看应用日志了解备份执行情况：
```bash
# 查看备份相关日志
grep "backup" logs/app.log
```

## 故障排除

### 常见问题

1. **备份文件发送失败**
   - 检查机器人是否有发送文件的权限
   - 确认目标聊天ID是否正确
   - 检查网络连接状态

2. **SQLite数据库文件正在使用**
   - 系统会自动处理活跃的数据库文件
   - 如果可能，会创建数据库快照以确保一致性
   - 即使出现"file changed as we read it"警告，备份仍然有效

3. **tar命令执行失败**
   - 系统已自动处理文件变更期间的警告
   - 添加了 `--ignore-failed-read` 选项处理读取失败
   - 如仍有问题，检查磁盘空间是否充足

4. **权限问题**
   - 确保应用有读取 `/app` 目录的权限
   - 检查备份目录的写入权限
   - 确保有执行 `sqlite3` 命令的权限（用于数据库快照）

### 日志级别

备份相关的日志信息：
- `INFO`: 备份开始、完成、文件发送等正常操作
- `WARN`: 非致命性警告，如文件清理失败
- `ERROR`: 备份失败、发送失败等错误情况

## 安全注意事项

1. **敏感信息保护**
   - 备份文件可能包含敏感配置信息
   - 确保目标聊天的安全性
   - 定期检查备份文件的访问权限

2. **存储空间管理**
   - 合理设置保留天数避免磁盘空间不足
   - 监控备份文件大小和频率

3. **网络安全**
   - 使用安全的网络连接发送备份文件
   - 考虑对敏感备份进行加密

## 性能优化建议

1. **备份时间选择**
   - 在系统负载较低时进行备份
   - 避免在高峰期执行大量备份操作

2. **压缩设置**
   - 对于大文件建议启用压缩
   - 对于小文件可考虑关闭压缩提高速度

3. **保留策略**
   - 根据实际需求设置合理的保留天数
   - 定期评估备份策略的有效性