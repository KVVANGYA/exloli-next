# 数据库备份功能

## 功能概述

本项目新增了自动数据库备份功能，可以定时将数据库文件备份并发送到指定的 Telegram 频道或群组。

## 配置说明

在 `config.toml` 文件中添加以下配置：

```toml
[backup]
# 是否启用定时备份
enabled = true
# 备份间隔（小时）
interval_hours = 24
# 备份目标频道/群组ID（可以是私有频道或群组）
target_chat_id = -1001234567890
# 备份文件保留天数（注意：目前仅作为配置保留，实际清理功能需要手动实现）
retention_days = 7
# 是否压缩备份文件
compress = true
# 备份文件前缀
file_prefix = "exloli_backup"
```

### 配置参数详解

- **enabled**: 是否启用备份功能，设置为 `false` 可以完全禁用备份
- **interval_hours**: 备份间隔时间，单位为小时。例如设置为 24 表示每天备份一次
- **target_chat_id**: 备份文件发送的目标频道或群组 ID
  - 可以是私有频道（推荐）
  - 也可以是群组
  - 确保 bot 有发送文档的权限
- **retention_days**: 备份文件保留天数（当前版本仅作配置保留）
- **compress**: 是否压缩备份文件
  - `true`: 使用 gzip 压缩，文件更小但需要解压
  - `false`: 直接备份原始数据库文件
- **file_prefix**: 备份文件名前缀，最终文件名格式为 `{prefix}_{timestamp}.db[.gz]`

## 使用方法

### 自动备份

启动程序后，如果 `backup.enabled = true`，系统会自动按照设定的间隔进行备份。

### 手动备份

管理员可以使用以下命令手动触发备份：

```
/backup
```

此命令只有管理员可以使用。

## 备份文件格式

- **未压缩**: `exloli_backup_20240829_143000.db`
- **压缩**: `exloli_backup_20240829_143000.db.gz`

文件名包含时间戳，格式为 `YYYYMMDD_HHMMSS`。

## 备份消息格式

备份完成后，bot 会发送包含以下信息的消息：

```
🗄️ **数据库备份**

📅 备份时间: 2024-08-29 14:30:00 UTC
📦 文件大小: 15.23 MB
🔧 压缩: 是
```

## 注意事项

1. **权限要求**: 确保 bot 在目标频道/群组中有发送文档的权限
2. **存储空间**: 定期检查目标频道的存储使用情况
3. **安全性**: 建议使用私有频道存储备份文件
4. **文件大小限制**: Telegram 文档大小限制为 2GB
5. **网络稳定性**: 备份过程需要稳定的网络连接

## 故障排除

### 备份失败常见原因

1. **权限不足**: bot 没有在目标频道发送文档的权限
2. **频道 ID 错误**: `target_chat_id` 配置错误
3. **数据库文件不存在**: `database_url` 路径错误
4. **网络问题**: 上传过程中网络中断

### 日志查看

备份相关的日志会输出到控制台，可以通过日志查看备份状态：

```
INFO  备份操作完成
ERROR 备份失败: 权限不足
```

## 恢复数据库

要恢复备份的数据库：

1. 从 Telegram 下载备份文件
2. 如果是压缩文件（.gz），先解压：
   ```bash
   gunzip exloli_backup_20240829_143000.db.gz
   ```
3. 停止程序
4. 替换现有数据库文件
5. 重启程序

## 未来改进

- [ ] 实现自动清理过期备份文件
- [ ] 支持增量备份
- [ ] 支持多个备份目标
- [ ] 备份验证和完整性检查
- [ ] 备份恢复命令