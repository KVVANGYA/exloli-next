# 应用程序完整备份功能

## 功能概述

本项目新增了自动应用程序完整备份功能，可以定时将整个 `/app` 目录（包括所有文件和子目录）打包备份并发送到指定的 Telegram 频道或群组。

## 配置说明

在 `config.toml` 文件中添加以下配置：

```toml
[backup]
# 是否启用定时备份
enabled = true
# 备份间隔（小时）
interval_hours = 24
# 备份目标频道/群组ID（可以是私有频道或群组）
target_chat_id = -1001234567890
# 是否启用文件保留天数功能
enable_retention = false
# 备份文件保留天数（仅在 enable_retention = true 时生效）
retention_days = 7
# 是否压缩备份文件
compress = true
# 备份文件前缀
file_prefix = "exloli_backup"
```
=======

### 文件保留功能说明

- **禁用保留功能** (`enable_retention = false`): 备份文件会一直保留在目标频道中，需要手动管理
- **启用保留功能** (`enable_retention = true`): 系统会尝试自动清理超过指定天数的备份文件

> **注意**: 自动清理功能需要额外的数据库表来跟踪已发送的备份消息，当前版本仅提供配置选项和框架代码。

### 配置参数详解

- **enabled**: 是否启用备份功能，设置为 `false` 可以完全禁用备份
- **interval_hours**: 备份间隔时间，单位为小时。例如设置为 24 表示每天备份一次
- **target_chat_id**: 备份文件发送的目标频道或群组 ID
  - 可以是私有频道（推荐）
  - 也可以是群组
  - 确保 bot 有发送文档的权限
- **enable_retention**: 是否启用文件保留天数功能
  - `true`: 启用自动清理过期备份文件功能
  - `false`: 禁用自动清理，备份文件会一直保留
- **retention_days**: 备份文件保留天数（仅在 enable_retention = true 时生效）
- **compress**: 是否压缩备份文件
  - `true`: 使用 tar.gz 格式（压缩，文件更小）
  - `false`: 使用 tar 格式（仅打包，不压缩，文件较大）
- **file_prefix**: 备份文件名前缀，最终文件名格式为：
  - 压缩: `{prefix}_{timestamp}.tar.gz`
  - 不压缩: `{prefix}_{timestamp}.tar`

## 使用方法

### 自动备份

启动程序后，如果 `backup.enabled = true`，系统会自动按照设定的间隔进行备份。

### 手动备份

管理员可以使用以下命令手动触发备份：

```
/backup
```

此命令只有管理员可以使用。

## 备份文件格式

根据 `compress` 配置，备份文件格式如下：

- **压缩备份** (`compress = true`): `exloli_backup_20240829_143000.tar.gz`
- **未压缩备份** (`compress = false`): `exloli_backup_20240829_143000.tar`

文件名包含时间戳，格式为 `YYYYMMDD_HHMMSS`。

## 备份消息格式

备份完成后，bot 会发送包含以下信息的消息：

**压缩备份** (`compress = true`):
```
🗄️ **应用程序完整备份**

📅 备份时间: 2024-08-29 14:30:00 UTC
📦 文件大小: 15.23 MB
📁 备份内容: /app 目录完整备份
🔧 格式: tar.gz 压缩包
```

**未压缩备份** (`compress = false`):
```
🗄️ **应用程序完整备份**

📅 备份时间: 2024-08-29 14:30:00 UTC
📦 文件大小: 45.67 MB
📁 备份内容: /app 目录完整备份
🔧 格式: tar 未压缩包
```

## 注意事项

1. **权限要求**: 确保 bot 在目标频道/群组中有发送文档的权限
2. **存储空间**: 定期检查目标频道的存储使用情况，完整目录备份文件可能较大
3. **安全性**: 建议使用私有频道存储备份文件，备份包含完整应用程序代码
4. **文件大小限制**: Telegram 文档大小限制为 2GB，大型应用可能需要分卷备份
5. **网络稳定性**: 备份过程需要稳定的网络连接
6. **系统要求**: 需要系统安装 `tar` 命令用于创建压缩包

## 故障排除

### 备份失败常见原因

1. **权限不足**: bot 没有在目标频道发送文档的权限
2. **频道 ID 错误**: `target_chat_id` 配置错误
3. **数据库文件不存在**: `database_url` 路径错误
4. **网络问题**: 上传过程中网络中断

### 日志查看

备份相关的日志会输出到控制台，可以通过日志查看备份状态：

```
INFO  备份操作完成
ERROR 备份失败: 权限不足
```

## 恢复应用程序

要恢复备份的应用程序：

1. 从 Telegram 下载备份文件

2. 根据文件格式解压：
   
   **压缩格式** (`.tar.gz`):
   ```bash
   tar -xzf exloli_backup_20240829_143000.tar.gz
   ```
   
   **未压缩格式** (`.tar`):
   ```bash
   tar -xf exloli_backup_20240829_143000.tar
   ```

3. 停止程序
4. 替换现有应用程序目录
5. 重启程序

**注意**: 完整恢复会替换整个应用程序目录，请确保备份当前重要数据。

## 未来改进

- [ ] 实现自动清理过期备份文件
- [ ] 支持增量备份
- [ ] 支持多个备份目标
- [ ] 备份验证和完整性检查
- [ ] 备份恢复命令